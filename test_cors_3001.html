<!DOCTYPE html>
<html>
<head>
    <title>测试 CORS 修复</title>
</head>
<body>
    <h1>测试 CORS 修复 (从 localhost:3001)</h1>
    
    <h2>1. 测试登录</h2>
    <button onclick="testLogin()">登录测试</button>
    <div id="loginResult"></div>
    
    <h2>2. 测试用户资料</h2>
    <button onclick="testProfile()">获取用户资料</button>
    <div id="profileResult"></div>
    
    <h2>3. 测试订单列表</h2>
    <button onclick="testOrders()">获取订单列表</button>
    <div id="ordersResult"></div>

    <script>
        let authToken = '';

        async function testLogin() {
            try {
                console.log('测试登录...');
                const response = await fetch('http://localhost:5000/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': 'http://localhost:3001'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        username: 'testuser',
                        password: '123456'
                    })
                });
                
                console.log('登录响应状态:', response.status);
                const data = await response.json();
                console.log('登录响应数据:', data);
                
                document.getElementById('loginResult').innerHTML = 
                    `<pre style="background: #f0f0f0; padding: 10px;">${JSON.stringify(data, null, 2)}</pre>`;
                
                if (data.success && data.data && data.data.token) {
                    authToken = data.data.token;
                    console.log('认证令牌已保存:', authToken.substring(0, 20) + '...');
                }
            } catch (error) {
                console.error('登录错误:', error);
                document.getElementById('loginResult').innerHTML = 
                    `<span style="color: red;">错误: ${error.message}</span>`;
            }
        }

        async function testProfile() {
            if (!authToken) {
                document.getElementById('profileResult').innerHTML = 
                    '<span style="color: red;">请先登录</span>';
                return;
            }

            try {
                console.log('测试用户资料...');
                const response = await fetch('http://localhost:5000/api/users/profile', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                        'Origin': 'http://localhost:3001'
                    },
                    credentials: 'include'
                });
                
                console.log('用户资料响应状态:', response.status);
                const data = await response.json();
                console.log('用户资料响应数据:', data);
                
                document.getElementById('profileResult').innerHTML = 
                    `<pre style="background: #f0f0f0; padding: 10px;">${JSON.stringify(data, null, 2)}</pre>`;
            } catch (error) {
                console.error('用户资料错误:', error);
                document.getElementById('profileResult').innerHTML = 
                    `<span style="color: red;">错误: ${error.message}</span>`;
            }
        }

        async function testOrders() {
            if (!authToken) {
                document.getElementById('ordersResult').innerHTML = 
                    '<span style="color: red;">请先登录</span>';
                return;
            }

            try {
                console.log('测试订单列表...');
                const response = await fetch('http://localhost:5000/api/orders', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                        'Origin': 'http://localhost:3001'
                    },
                    credentials: 'include'
                });
                
                console.log('订单列表响应状态:', response.status);
                const data = await response.json();
                console.log('订单列表响应数据:', data);
                
                document.getElementById('ordersResult').innerHTML = 
                    `<pre style="background: #f0f0f0; padding: 10px;">${JSON.stringify(data, null, 2)}</pre>`;
            } catch (error) {
                console.error('订单列表错误:', error);
                document.getElementById('ordersResult').innerHTML = 
                    `<span style="color: red;">错误: ${error.message}</span>`;
            }
        }
    </script>
</body>
</html>
